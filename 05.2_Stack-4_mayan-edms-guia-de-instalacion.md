# Guía de Instalación y Configuración de Mayan EDMS con FreeIPA
(para revisión)

Dr. Jesús Zavala Ruiz[^1]

11 de Febrero de 2026

---

## Parte 1: Instalación Mínima de Mayan EDMS en Rocky Linux 10

Esta guía proporciona los pasos para instalar una instancia mínima de Mayan EDMS en un servidor Rocky Linux 10, utilizando la imagen Docker oficial. Este método es el más rápido y recomendado para entornos de desarrollo y pruebas.

### Requisitos Previos

Antes de comenzar, asegúrese de que su servidor Rocky Linux 10 cumple con los siguientes requisitos:

*   **Sistema Operativo:** Rocky Linux 10
*   **Memoria RAM:** Mínimo 4 GB (8 GB recomendados para producción)
*   **CPU:** Mínimo 2 núcleos
*   **Almacenamiento:** Espacio suficiente para los documentos y la base de datos (depende del volumen documental)
*   **Software:** Docker y Docker Compose instalados

### Paso 1: Instalar Docker y Docker Compose

```bash
# Instalar Docker
sudo dnf install -y dnf-plugins-core
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# Iniciar y habilitar Docker
sudo systemctl enable --now docker

# Verificar la instalación
docker --version
```

### Paso 2: Crear el archivo `docker-compose.yml`

Cree un directorio para su instalación de Mayan EDMS y dentro de él, cree el archivo `docker-compose.yml`.

```bash
mkdir ~/mayan-edms && cd ~/mayan-edms
```

Cree el archivo `docker-compose.yml` con el siguiente contenido:

```yaml
version: '3.7'

services:
  mayan-edms:
    image: mayanedms/mayanedms:4.10.3
    restart: unless-stopped
    environment:
      MAYAN_DATABASE_ENGINE: django.db.backends.postgresql
      MAYAN_DATABASE_HOST: postgresql
      MAYAN_DATABASE_NAME: mayan
      MAYAN_DATABASE_PASSWORD: mayan_password
      MAYAN_DATABASE_USER: mayan
      MAYAN_BROKER_URL: "redis://redis:6379/0"
      MAYAN_CELERY_RESULT_BACKEND: "redis://redis:6379/0"
    ports:
      - "8000:8000"
    volumes:
      - mayan_media:/var/lib/mayan
    depends_on:
      - postgresql
      - redis

  postgresql:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: mayan
      POSTGRES_PASSWORD: mayan_password
      POSTGRES_USER: mayan
    volumes:
      - postgresql_/var/lib/postgresql/data

  redis:
    image: redis:7
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning

volumes:
  mayan_media:
  postgresql_
```

### Paso 3: Iniciar los servicios

Con el archivo `docker-compose.yml` en su lugar, inicie los servicios.

```bash
# Iniciar los contenedores en segundo plano
docker compose up -d

# Verificar que los contenedores se están ejecutando
docker compose ps
```

### Paso 4: Finalizar la configuración inicial

La primera vez que se inicia Mayan EDMS, debe crear un superusuario administrativo. Ejecute el siguiente comando para acceder al shell del contenedor y crear el usuario.

```bash
# Acceder al contenedor de Mayan EDMS
docker compose exec mayan-edms /bin/bash

# Dentro del contenedor, crear el superusuario
mayan-edms.py createsuperuser

# Salir del contenedor
exit
```

Durante la ejecución de `createsuperuser`, se le pedirá un nombre de usuario, dirección de correo electrónico y contraseña. Guarde estas credenciales, ya que las necesitará para iniciar sesión en la interfaz web.

### Paso 5: Acceder a la interfaz web

Abra un navegador web y navegue a `http://<IP_DEL_SERVIDOR>:8000`. Debería ver la página de inicio de sesión de Mayan EDMS. Inicie sesión con las credenciales del superusuario que acaba de crear.

¡La instalación mínima de Mayan EDMS está completa!

---

## Parte 2: Integración de Mayan EDMS con FreeIPA para Autenticación LDAP

Una vez que Mayan EDMS está instalado y funcionando, el siguiente paso es integrarlo con su servidor FreeIPA para permitir la autenticación centralizada de usuarios. Esto permite a los usuarios de su dominio FreeIPA iniciar sesión en Mayan EDMS sin necesidad de cuentas locales.

### Requisitos Previos

*   Un servidor FreeIPA 4.x o superior funcionando y accesible desde el servidor de Mayan EDMS.
*   Un grupo en FreeIPA (por ejemplo, `mayan-users`) que contendrá a los usuarios autorizados para acceder a Mayan EDMS.
*   Mayan EDMS instalado y funcionando (como se describe en la Parte 1).

### Paso 1: Preparar el entorno de Mayan EDMS

Para configurar la autenticación LDAP, Mayan EDMS requiere un archivo de configuración adicional llamado `settings_local.py`. Este archivo debe estar disponible dentro del contenedor de Mayan EDMS.

1.  **Crear un directorio local para la configuración:**
    ```bash
    mkdir -p ~/mayan-edms/config
    ```

2.  **Crear el archivo `settings_local.py`:**
    Cree el archivo `~/mayan-edms/config/settings_local.py` con el siguiente contenido, ajustando los valores entre `< >` a su entorno:

    ```python
    import ldap
    from django_auth_ldap.config import LDAPSearch, GroupOfNamesType

    # Habilitar la autenticación LDAP
    AUTHENTICATION_BACKENDS = (
        'django_auth_ldap.backend.LDAPBackend',
        'django.contrib.auth.backends.ModelBackend',
    )

    # Configuración del servidor LDAP (FreeIPA)
    AUTH_LDAP_SERVER_URI = "ldaps://<FQDN_DE_SU_SERVIDOR_FREEIPA>"
    AUTH_LDAP_START_TLS = False  # Usamos LDAPS, no STARTTLS

    # Bind anónimo para buscar usuarios
    AUTH_LDAP_BIND_DN = ""
    AUTH_LDAP_BIND_PASSWORD = ""

    # Búsqueda de usuarios
    AUTH_LDAP_USER_SEARCH = LDAPSearch(
        "cn=users,cn=accounts,dc=<SU_DOMINIO>,dc=<SU_TLD>",
        ldap.SCOPE_SUBTREE,
        "(uid=%(user)s)"
    )

    # Búsqueda de grupos
    AUTH_LDAP_GROUP_SEARCH = LDAPSearch(
        "cn=groups,cn=accounts,dc=<SU_DOMINIO>,dc=<SU_TLD>",
        ldap.SCOPE_SUBTREE,
        "(objectClass=groupOfNames)"
    )
    AUTH_LDAP_GROUP_TYPE = GroupOfNamesType(name_attr="cn")

    # Opciones de conexión
    AUTH_LDAP_CONNECTION_OPTIONS = {
        ldap.OPT_REFERRALS: 0,
        ldap.OPT_PROTOCOL_VERSION: 3,
        ldap.OPT_X_TLS_REQUIRE_CERT: ldap.OPT_X_TLS_NEVER, # Ajuste según su política de certificados
    }

    # Asignación de atributos de usuario
    AUTH_LDAP_USER_ATTR_MAP = {
        "first_name": "givenName",
        "last_name": "sn",
        "email": "mail",
    }

    # Sincronización de grupos
    AUTH_LDAP_FIND_GROUP_PERMS = True
    AUTH_LDAP_MIRROR_GROUPS = True

    # Permitir el login de cualquier usuario en el directorio
    # Para restringir el acceso solo a miembros de un grupo específico, use:
    # AUTH_LDAP_REQUIRE_GROUP = "cn=mayan-users,cn=groups,cn=accounts,dc=<SU_DOMINIO>,dc=<SU_TLD>"
    ```

    **Notas importantes sobre la configuración:**
    *   Reemplace `<FQDN_DE_SU_SERVIDOR_FREEIPA>` con el nombre de host completo de su servidor FreeIPA (por ejemplo, `ipa.example.com.mx`).
    *   Reemplace `<SU_DOMINIO>` y `<SU_TLD>` con su dominio DNS (por ejemplo, `example` y `com.mx`).
    *   La línea `AUTH_LDAP_REQUIRE_GROUP` está comentada. Si desea restringir el acceso solo a los miembros de un grupo específico en FreeIPA (recomendado), descomente esta línea y reemplace el DN del grupo con el suyo.

### Paso 2: Modificar el archivo `docker-compose.yml`

Ahora, debe montar el directorio de configuración local en el contenedor de Mayan EDMS para que el archivo `settings_local.py` sea accesible.

Edite su archivo `docker-compose.yml` y agregue un nuevo volumen en la sección del servicio `mayan-edms`:

```yaml
services:
  mayan-edms:
    # ... otras configuraciones existentes ...
    volumes:
      - mayan_media:/var/lib/mayan
      - ./config:/opt/mayan-edms/media/config  # <-- Agregar esta línea
    # ... resto del archivo ...
```

### Paso 3: Reiniciar Mayan EDMS

Detenga y vuelva a iniciar los servicios para que los cambios surtan efecto.

```bash
# Detener los servicios
docker compose down

# Iniciar los servicios nuevamente
docker compose up -d
```

### Paso 4: Probar la autenticación

1.  **Crear un usuario de prueba en FreeIPA (si no existe):**
    ```bash
    # En el servidor FreeIPA
    kinit admin
    ipa user-add --first=Mayan --last=User --password mayanuser
    ipa group-add-member --users=mayanuser mayan-users # Si usó AUTH_LDAP_REQUIRE_GROUP
    ```

2.  **Iniciar sesión en Mayan EDMS:**
    Abra la interfaz web de Mayan EDMS (`http://<IP_DEL_SERVIDOR>:8000`). Intente iniciar sesión con el nombre de usuario (`mayanuser`) y la contraseña del usuario que creó en FreeIPA.

Si la configuración es correcta, el usuario debería poder iniciar sesión. La primera vez que un usuario LDAP inicia sesión, Mayan EDMS creará automáticamente una cuenta local vinculada a su identidad LDAP. El superusuario local que creó durante la instalación seguirá funcionando para tareas de administración.

**Consejo para la administración:** Para asignar roles y permisos a los nuevos usuarios LDAP, vaya a la interfaz de administración de Mayan EDMS (`Menú > Administración > Usuarios`) y edite el usuario recién creado para asignarle los roles adecuados.

Con estos pasos, ha integrado con éxito Mayan EDMS con su infraestructura de identidad centralizada en FreeIPA, mejorando la seguridad y simplificando la gestión de usuarios en su stack tecnológico.

---

## Parte 3: Orquestación de la Instalación con Ansible

Para gestionar la instalación y configuración de Mayan EDMS de forma reproducible y escalable en múltiples servidores, se puede utilizar Ansible. Esta guía proporciona un playbook básico que automatiza todos los pasos descritos anteriormente.

### Requisitos Previos

*   Un sistema de control con Ansible instalado (versión 2.9 o superior).
*   Acceso SSH con clave pública al servidor objetivo (Rocky Linux 10).
*   Los mismos requisitos previos del servidor objetivo que en la Parte 1.

### Paso 1: Crear la estructura de directorios del proyecto Ansible

```bash
mkdir -p mayan-ansible/{roles,mayan-edms}
cd mayan-ansible
```

### Paso 2: Crear el inventario

Cree un archivo `inventory.ini` con la dirección IP de su servidor.

```ini
[mayan_servers]
mayan-host ansible_host=192.168.1.100 ansible_user=your_user
```

### Paso 3: Crear el archivo de variables

Cree un archivo `vars.yml` para definir las variables del entorno.

```yaml
---
# Variables para Mayan EDMS
mayan_version: "4.10.3"
mayan_port: 8000
mayan_db_name: "mayan"
mayan_db_user: "mayan"
mayan_db_password: "mayan_secure_password"

# Variables para FreeIPA (dejar vacías si no se usa LDAP inmediatamente)
freeipa_enabled: true
freeipa_server_fqdn: "ipa.example.com.mx"
freeipa_base_dn: "dc=example,dc=com,dc=mx"
freeipa_require_group: "cn=mayan-users,cn=groups,cn=accounts,dc=example,dc=com,dc=mx"
```

### Paso 4: Crear el rol de instalación de Docker

Cree el directorio del rol y sus archivos.

```bash
mkdir -p roles/install_docker/{tasks,handlers}
```

**`roles/install_docker/tasks/main.yml`:**
```yaml
---
- name: Install required packages for Docker
  dnf:
    name:
      - dnf-plugins-core
    state: present

- name: Add Docker CE repository
  shell: |
    dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  args:
    warn: false

- name: Install Docker and Docker Compose
  dnf:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present

- name: Ensure Docker is started and enabled
  systemd:
    name: docker
    state: started
    enabled: yes
```

### Paso 5: Crear el rol de despliegue de Mayan EDMS

Cree el directorio del rol y sus archivos.

```bash
mkdir -p roles/deploy_mayan/{tasks,templates,files}
```

**`roles/deploy_mayan/templates/docker-compose.yml.j2`:**
```jinja2
version: '3.7'

services:
  mayan-edms:
    image: mayanedms/mayanedms:{{ mayan_version }}
    restart: unless-stopped
    environment:
      MAYAN_DATABASE_ENGINE: django.db.backends.postgresql
      MAYAN_DATABASE_HOST: postgresql
      MAYAN_DATABASE_NAME: {{ mayan_db_name }}
      MAYAN_DATABASE_PASSWORD: {{ mayan_db_password }}
      MAYAN_DATABASE_USER: {{ mayan_db_user }}
      MAYAN_BROKER_URL: "redis://redis:6379/0"
      MAYAN_CELERY_RESULT_BACKEND: "redis://redis:6379/0"
    ports:
      - "{{ mayan_port }}:8000"
    volumes:
      - mayan_media:/var/lib/mayan
      {% if freeipa_enabled %}
      - ./config:/opt/mayan-edms/media/config
      {% endif %}
    depends_on:
      - postgresql
      - redis

  postgresql:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: {{ mayan_db_name }}
      POSTGRES_PASSWORD: {{ mayan_db_password }}
      POSTGRES_USER: {{ mayan_db_user }}
    volumes:
      - postgresql_/var/lib/postgresql/data

  redis:
    image: redis:7
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning

volumes:
  mayan_media:
  postgresql_
```

**`roles/deploy_mayan/templates/settings_local.py.j2`:**
```jinja2
import ldap
from django_auth_ldap.config import LDAPSearch, GroupOfNamesType

# Habilitar la autenticación LDAP
AUTHENTICATION_BACKENDS = (
    'django_auth_ldap.backend.LDAPBackend',
    'django.contrib.auth.backends.ModelBackend',
)

# Configuración del servidor LDAP (FreeIPA)
AUTH_LDAP_SERVER_URI = "ldaps://{{ freeipa_server_fqdn }}"
AUTH_LDAP_START_TLS = False

# Bind anónimo para buscar usuarios
AUTH_LDAP_BIND_DN = ""
AUTH_LDAP_BIND_PASSWORD = ""

# Búsqueda de usuarios
AUTH_LDAP_USER_SEARCH = LDAPSearch(
    "cn=users,cn=accounts,{{ freeipa_base_dn }}",
    ldap.SCOPE_SUBTREE,
    "(uid=%(user)s)"
)

# Búsqueda de grupos
AUTH_LDAP_GROUP_SEARCH = LDAPSearch(
    "cn=groups,cn=accounts,{{ freeipa_base_dn }}",
    ldap.SCOPE_SUBTREE,
    "(objectClass=groupOfNames)"
)
AUTH_LDAP_GROUP_TYPE = GroupOfNamesType(name_attr="cn")

# Opciones de conexión
AUTH_LDAP_CONNECTION_OPTIONS = {
    ldap.OPT_REFERRALS: 0,
    ldap.OPT_PROTOCOL_VERSION: 3,
    ldap.OPT_X_TLS_REQUIRE_CERT: ldap.OPT_X_TLS_NEVER,
}

# Asignación de atributos de usuario
AUTH_LDAP_USER_ATTR_MAP = {
    "first_name": "givenName",
    "last_name": "sn",
    "email": "mail",
}

# Sincronización de grupos
AUTH_LDAP_FIND_GROUP_PERMS = True
AUTH_LDAP_MIRROR_GROUPS = True

# Restringir acceso al grupo especificado
AUTH_LDAP_REQUIRE_GROUP = "{{ freeipa_require_group }}"
```

**`roles/deploy_mayan/tasks/main.yml`:**
```yaml
---
- name: Create Mayan EDMS project directory
  file:
    path: /opt/mayan-edms
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Copy docker-compose.yml template
  template:
    src: docker-compose.yml.j2
    dest: /opt/mayan-edms/docker-compose.yml
    owner: root
    group: root
    mode: '0644'

- name: Create config directory for LDAP (if enabled)
  file:
    path: /opt/mayan-edms/config
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: freeipa_enabled

- name: Copy settings_local.py for LDAP (if enabled)
  template:
    src: settings_local.py.j2
    dest: /opt/mayan-edms/config/settings_local.py
    owner: root
    group: root
    mode: '0644'
  when: freeipa_enabled

- name: Start Mayan EDMS services with docker-compose
  shell: docker compose up -d
  args:
    chdir: /opt/mayan-edms
  register: mayan_start_result

- name: Wait for Mayan EDMS to be ready
  wait_for:
    port: "{{ mayan_port }}"
    host: "127.0.0.1"
    delay: 10
    timeout: 60
  when: mayan_start_result.changed
```

### Paso 6: Crear el playbook principal

Cree el archivo `site.yml` en el directorio raíz del proyecto.

```yaml
---
- name: Deploy Mayan EDMS on Rocky Linux 10
  hosts: mayan_servers
  become: yes
  vars_files:
    - vars.yml
  roles:
    - install_docker
    - deploy_mayan
```

### Paso 7: Ejecutar el playbook

Desde el directorio `mayan-ansible`, ejecute el playbook.

```bash
ansible-playbook -i inventory.ini site.yml
```

Este playbook instalará Docker, desplegará Mayan EDMS y configurará la integración con FreeIPA si las variables correspondientes están definidas. Para completar la instalación, aún necesitará crear manualmente el superusuario administrativo en el contenedor, ya que este paso interactivo no se puede automatizar fácilmente sin exponer credenciales sensibles. Sin embargo, toda la infraestructura estará lista y configurada de forma reproducible y coherente.

---
[^1]: Profesor-investigador del Departamento de Economía de la Universidad Autónoma Metropolitana, Unidad Iztapalapa. email: [jzr@xanum.uam.mx](mailto:jzr@xanum.uam.mx), [https://t.me/jzavalar](https://t.me/jzavalar).
